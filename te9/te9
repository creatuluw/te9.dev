#!/bin/bash

# te9 - Unified te9.dev Management Script
# Works on Linux, macOS, and Windows (Git Bash)
# Usage: curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash

set -e

# Configuration
REPO="creatuluw/te9.dev"
BRANCH="main"
RAW_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Functions
log_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; }
log_success() { echo -e "${GREEN}‚úÖ${NC} $1"; }
log_warn() { echo -e "${YELLOW}‚ö†Ô∏è${NC} $1"; }
log_error() { echo -e "${RED}‚ùå${NC} $1"; }
log_cmd() { echo -e "${CYAN}‚ûú${NC} $1"; }

# Detect platform
detect_platform() {
    case "$(uname -s)" in
        Linux*)     PLATFORM="linux";;
        Darwin*)    PLATFORM="macos";;
        MINGW*|MSYS*|CYGWIN*) PLATFORM="windows";;
        *)          PLATFORM="unknown";;
    esac
}

# Show help
show_help() {
    echo -e "${BOLD}te9 - te9.dev Management Script${NC}"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash [command]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  ${CYAN}install${NC}    Install te9.dev in current directory"
    echo "  ${CYAN}update${NC}     Update te9.dev to latest version"
    echo "  ${CYAN}status${NC}     Check installation status"
    echo "  ${CYAN}version${NC}    Show version information"
    echo "  ${CYAN}help${NC}       Show this help message"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash install"
    echo "  curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash update"
    echo "  curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash status"
    echo ""
    echo -e "${BOLD}More Info:${NC}"
    echo "  https://github.com/${REPO}"
}

# Show version
show_version() {
    echo "te9.dev v1.0.0"
    echo "Platform: $PLATFORM"
    echo "Repository: https://github.com/${REPO}"
}

# Check if in git repo
check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        log_warn "Not in a git repository"
        read -p "Run 'git init' first? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git init
            log_success "Initialized git repository"
        else
            log_info "Continuing anyway..."
        fi
    fi
}

# Check if te9.dev is installed
check_installed() {
    if [ ! -f "opencode.json" ] || [ ! -f "openmemory.md" ]; then
        log_error "te9.dev is not installed in this directory"
        log_info "To install te9.dev, run: curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash install"
        exit 1
    fi
    log_success "Found te9.dev installation"
}

# Create directory structure
create_directories() {
    log_info "Creating directory structure..."

    mkdir -p .opencode/skill/te9-init
    mkdir -p .opencode/skill/spec-clarify
    mkdir -p .opencode/skill/spec-store
    mkdir -p .opencode/skill/spec-execute
    mkdir -p .opencode/skill/spec-commit
    mkdir -p .opencode/skill/spec-track
    mkdir -p .opencode/tool
    mkdir -p te9.dev/specs
    mkdir -p te9.dev/logs

    log_success "Created directory structure"
}

# Download file
download_file() {
    local url="$1"
    local dest="$2"

    log_info "Downloading: $(basename "$dest")"
    if curl -fsSL "$url" -o "$dest"; then
        log_success "Downloaded: $(basename "$dest")"
    else
        log_error "Failed to download: $(basename "$dest")"
        return 1
    fi
}

# Download all files
download_files() {
    log_info "Downloading te9.dev files from GitHub..."
    log_cmd "Source: ${RAW_URL}"

    # Core files
    download_file "${RAW_URL}/opencode.json" "opencode.json"
    download_file "${RAW_URL}/openmemory.md" "openmemory.md"
    download_file "${RAW_URL}/README.md" "README.md"
    download_file "${RAW_URL}/te9.md" "te9.md"

    # Skills
    download_file "${RAW_URL}/.opencode/skill/te9-init/SKILL.md" ".opencode/skill/te9-init/SKILL.md"
    download_file "${RAW_URL}/.opencode/skill/spec-clarify/SKILL.md" ".opencode/skill/spec-clarify/SKILL.md"
    download_file "${RAW_URL}/.opencode/skill/spec-store/SKILL.md" ".opencode/skill/spec-store/SKILL.md"
    download_file "${RAW_URL}/.opencode/skill/spec-execute/SKILL.md" ".opencode/skill/spec-execute/SKILL.md"
    download_file "${RAW_URL}/.opencode/skill/spec-commit/SKILL.md" ".opencode/skill/spec-commit/SKILL.md"
    download_file "${RAW_URL}/.opencode/skill/spec-track/SKILL.md" ".opencode/skill/spec-track/SKILL.md"

    # Skill README
    download_file "${RAW_URL}/.opencode/skill/README.md" ".opencode/skill/README.md"

    # Tools
    download_file "${RAW_URL}/.opencode/tool/daisyui.ts" ".opencode/tool/daisyui.ts"
    download_file "${RAW_URL}/.opencode/tool/knowledge_graph.ts" ".opencode/tool/knowledge_graph.ts"
    download_file "${RAW_URL}/.opencode/tool/melt.ts" ".opencode/tool/melt.ts"
    download_file "${RAW_URL}/.opencode/tool/uikit.ts" ".opencode/tool/uikit.ts"

    log_success "All files downloaded"
}

# Initialize specs database
init_specs() {
    if [ ! -f te9.dev/specs.json ]; then
        echo '{}' > te9.dev/specs.json
        log_success "Created: te9.dev/specs.json"
    fi
}

# Verify installation
verify_installation() {
    log_info "Verifying installation..."

    local required=(
        "opencode.json"
        "openmemory.md"
        ".opencode/skill/te9-init/SKILL.md"
        ".opencode/skill/spec-clarify/SKILL.md"
        ".opencode/skill/spec-store/SKILL.md"
        ".opencode/skill/spec-execute/SKILL.md"
        ".opencode/skill/spec-commit/SKILL.md"
        ".opencode/skill/spec-track/SKILL.md"
    )

    local all_present=true
    for file in "${required[@]}"; do
        if [ -f "$file" ]; then
            log_success "$file"
        else
            log_error "$file"
            all_present=false
        fi
    done

    [ -d te9.dev/specs ] && log_success "te9.dev/specs/" || log_error "te9.dev/specs/"
    [ -d te9.dev/logs ] && log_success "te9.dev/logs/" || log_error "te9.dev/logs/"

    if [ "$all_present" = true ]; then
        log_success "‚úÖ Installation verified!"
    else
        log_error "‚ùå Installation incomplete"
        return 1
    fi
}

# Backup existing files
backup_files() {
    BACKUP_DIR=".te9-backup-$(date +%Y%m%d-%H%M%S)"
    log_info "Creating backup: $BACKUP_DIR"

    mkdir -p "$BACKUP_DIR"

    # Backup configs
    [ -f opencode.json ] && cp opencode.json "$BACKUP_DIR/"
    [ -f openmemory.md ] && cp openmemory.md "$BACKUP_DIR/"
    [ -f README.md ] && cp README.md "$BACKUP_DIR/"
    [ -f te9.md ] && cp te9.md "$BACKUP_DIR/"

    # Backup skills
    cp -r .opencode/skill "$BACKUP_DIR/"

    # Backup tools
    cp -r .opencode/tool "$BACKUP_DIR/"

    log_success "Backup created at: $BACKUP_DIR"
}

# Download file with backup
download_file_with_backup() {
    local url="$1"
    local dest="$2"

    # Backup existing file
    if [ -f "$dest" ]; then
        cp "$dest" "${dest}.old"
    fi

    log_info "Downloading: $(basename "$dest")"
    if curl -fsSL "$url" -o "$dest"; then
        log_success "Updated: $(basename "$dest")"
        rm -f "${dest}.old"
    else
        log_error "Failed to download: $(basename "$dest")"
        # Restore backup
        if [ -f "${dest}.old" ]; then
            mv "${dest}.old" "$dest"
            log_info "Restored backup"
        fi
        return 1
    fi
}

# Update files
update_files() {
    log_info "Updating te9.dev files..."
    log_cmd "Source: ${RAW_URL}"

    # Core files
    download_file_with_backup "${RAW_URL}/opencode.json" "opencode.json"
    download_file_with_backup "${RAW_URL}/openmemory.md" "openmemory.md"
    download_file_with_backup "${RAW_URL}/README.md" "README.md"
    download_file_with_backup "${RAW_URL}/te9.md" "te9.md"

    # Skills
    download_file_with_backup "${RAW_URL}/.opencode/skill/te9-init/SKILL.md" ".opencode/skill/te9-init/SKILL.md"
    download_file_with_backup "${RAW_URL}/.opencode/skill/spec-clarify/SKILL.md" ".opencode/skill/spec-clarify/SKILL.md"
    download_file_with_backup "${RAW_URL}/.opencode/skill/spec-store/SKILL.md" ".opencode/skill/spec-store/SKILL.md"
    download_file_with_backup "${RAW_URL}/.opencode/skill/spec-execute/SKILL.md" ".opencode/skill/spec-execute/SKILL.md"
    download_file_with_backup "${RAW_URL}/.opencode/skill/spec-commit/SKILL.md" ".opencode/skill/spec-commit/SKILL.md"
    download_file_with_backup "${RAW_URL}/.opencode/skill/spec-track/SKILL.md" ".opencode/skill/spec-track/SKILL.md"

    # Skill README
    download_file_with_backup "${RAW_URL}/.opencode/skill/README.md" ".opencode/skill/README.md"

    # Tools
    download_file_with_backup "${RAW_URL}/.opencode/tool/daisyui.ts" ".opencode/tool/daisyui.ts"
    download_file_with_backup "${RAW_URL}/.opencode/tool/knowledge_graph.ts" ".opencode/tool/knowledge_graph.ts"
    download_file_with_backup "${RAW_URL}/.opencode/tool/melt.ts" ".opencode/tool/melt.ts"
    download_file_with_backup "${RAW_URL}/.opencode/tool/uikit.ts" ".opencode/tool/uikit.ts"

    log_success "All files updated"
}

# Verify update
verify_update() {
    log_info "Verifying update..."

    local required=(
        "opencode.json"
        "openmemory.md"
        ".opencode/skill/te9-init/SKILL.md"
        ".opencode/skill/spec-clarify/SKILL.md"
        ".opencode/skill/spec-store/SKILL.md"
        ".opencode/skill/spec-execute/SKILL.md"
        ".opencode/skill/spec-commit/SKILL.md"
        ".opencode/skill/spec-track/SKILL.md"
    )

    local all_present=true
    for file in "${required[@]}"; do
        if [ -f "$file" ]; then
            log_success "$file"
        else
            log_error "$file"
            all_present=false
        fi
    done

    if [ "$all_present" = true ]; then
        log_success "‚úÖ Update verified!"
    else
        log_error "‚ùå Update incomplete"
        return 1
    fi
}

# Check status
check_status() {
    log_info "Checking te9.dev status..."
    echo ""

    # Required files
    echo "=== Required Files ==="
    declare -a REQUIRED=(
        "opencode.json:Core configuration"
        "openmemory.md:Memory system rules"
        ".opencode/skill/te9-init/SKILL.md:Initialization"
        ".opencode/skill/spec-clarify/SKILL.md:Clarification"
        ".opencode/skill/spec-store/SKILL.md:Spec storage"
        ".opencode/skill/spec-execute/SKILL.md:Execution"
        ".opencode/skill/spec-commit/SKILL.md:Commit workflow"
        ".opencode/skill/spec-track/SKILL.md:Progress tracking"
    )

    local all_present=true
    local total=0
    local present=0

    for item in "${REQUIRED[@]}"; do
        local file="${item%%:*}"
        local desc="${item##*:}"
        total=$((total + 1))

        if [ -f "$file" ]; then
            log_success "$file"
            present=$((present + 1))
        else
            log_error "$file"
            all_present=false
        fi
    done

    echo ""
    log_info "Required files: $present/$total present"

    # Optional tools
    echo ""
    echo "=== Technical Tools (Optional) ==="
    declare -a TOOLS=(
        ".opencode/tool/daisyui.ts:UI templates"
        ".opencode/tool/knowledge_graph.ts:Memory graph"
        ".opencode/tool/melt.ts:Svelte UI"
        ".opencode/tool/uikit.ts:UI generator"
    )

    local tools_total=0
    local tools_present=0

    for item in "${TOOLS[@]}"; do
        local file="${item%%:*}"
        local desc="${item##*:}"
        tools_total=$((tools_total + 1))

        if [ -f "$file" ]; then
            log_success "$file"
            tools_present=$((tools_present + 1))
        else
            echo "  ‚ö™ $file (not installed)"
        fi
    done

    echo ""
    log_info "Technical tools: $tools_present/$tools_total installed"

    # Project structure
    echo ""
    echo "=== Project Structure ==="

    if [ -d "te9.dev/specs" ]; then
        log_success "te9.dev/specs/"
        local spec_count=$(find te9.dev/specs -name "spec.md" 2>/dev/null | wc -l)
        if [ "$spec_count" -gt 0 ]; then
            echo "    üìä $spec_count spec(s) found"
        fi
    else
        log_error "te9.dev/specs/"
    fi

    if [ -d "te9.dev/logs" ]; then
        log_success "te9.dev/logs/"
        local log_count=$(find te9.dev/logs -name "*.log" 2>/dev/null | wc -l)
        if [ "$log_count" -gt 0 ]; then
            echo "    üìä $log_count log(s) found"
        fi
    else
        log_error "te9.dev/logs/"
    fi

    if [ -f "te9.dev/specs.json" ]; then
        log_success "te9.dev/specs.json"
    else
        echo "  ‚ö™ te9.dev/specs.json (will be created on first spec)"
    fi

    # Git status
    echo ""
    echo "=== Git Status ==="

    if git rev-parse --git-dir > /dev/null 2>&1; then
        log_success "Git repository"

        local uncommitted=$(git status --porcelain | wc -l)
        if [ "$uncommitted" -eq 0 ]; then
            echo "    üìå Working directory clean"
        else
            echo "    ‚ö†Ô∏è  $uncommitted uncommitted change(s)"
        fi

        local branch=$(git branch --show-current)
        echo "    üåø Branch: $branch"
    else
        log_warn "Not a git repository"
    fi

    # Summary
    echo ""
    echo "=== Summary ==="
    echo ""
    log_info "For more information: https://github.com/${REPO}"
    echo ""

    if [ "$all_present" = true ]; then
        log_success "‚úÖ te9.dev is fully installed and ready to use!"
        echo ""
        log_info "Next steps:"
        echo "  1. Open your project in OpenCode or Zed"
        echo "  2. Run: skill('te9-init')"
        echo "  3. Start using te9.dev workflow!"
    else
        log_warn "‚ö†Ô∏è  te9.dev installation incomplete"
        echo ""
        log_info "To fix installation, run:"
        echo "  curl -fsSL https://github.com/creatuluw/te9.dev/te9/te9 | bash install"
    fi
}

# Install command
cmd_install() {
    detect_platform
    log_info "Installing te9.dev..."
    echo ""

    check_git_repo
    create_directories
    download_files
    init_specs
    verify_installation

    echo ""
    log_success "üéâ te9.dev installed successfully!"
    echo ""
    log_info "Next steps:"
    echo "  1. Open your project in OpenCode or Zed"
    echo "  2. Run: skill('te9-init')"
    echo "  3. Start using te9.dev workflow!"
    echo ""
    log_info "For help: https://github.com/${REPO}"
}

# Update command
cmd_update() {
    detect_platform
    check_installed
    log_info "Updating te9.dev..."
    echo ""

    backup_files
    create_directories
    update_files
    verify_update

    echo ""
    log_success "üéâ te9.dev updated successfully!"
    echo ""
    log_info "Your specs and logs are preserved in: te9.dev/"
    log_info "Backup created at: $BACKUP_DIR"
    echo ""
    log_info "Ready to continue using te9.dev!"
    echo ""
    log_info "For help: https://github.com/${REPO}"
}

# Status command
cmd_status() {
    detect_platform
    check_status
}

# Main
main() {
    local command="${1:-help}"

    case "$command" in
        install)
            cmd_install
            ;;
        update)
            cmd_update
            ;;
        status)
            cmd_status
            ;;
        version|--version|-v)
            detect_platform
            show_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main
main "$@"
